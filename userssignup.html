<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Share-a-Ride</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS for refined message box, form, and card styles */
        /* These styles are taken directly from your provided HTML */

        /* Refined Message Box */
        #message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f0fdf4;
            color: #15803d;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #16a34a;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 250px; /* Ensure it's readable */
            text-align: center;
        }
        #message-box.show {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #message-box.error {
            background-color: #fee2e2;
            color: #dc2626;
            border-color: #dc2626;
        }

        /* General Form Styles */
        .form-container {
            background-color: #f7fafc;
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 12px 24px -6px rgba(0, 0, 0, 0.15), 0 6px 12px -4px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .form-container:hover, .form-container:focus-within {
            box-shadow: 0 0 20px rgba(125, 211, 252, 0.4);
            border-color: #7dd3fc;
        }

        .form-title-panel {
            background-image: linear-gradient(to right, #4a5568, #2d3748);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem 0.75rem 0 0;
            margin-bottom: 2rem;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            user-select: none;
        }

        .form-container div {
            margin-bottom: 1.5rem;
        }

        .form-container label {
            font-weight: 500;
            color: #4a5568;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            transition: color 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .form-container label:hover {
            color: #2d3748;
        }

        .form-container input, .form-container textarea, .form-container select {
            border-radius: 0.75rem;
            padding: 0.8rem;
            border: 1px solid #cbd5e0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            width: 100%;
            font-size: 1rem;
            line-height: 1.5;
            background-color: white;
            cursor: text;
        }

        .form-container input:focus, .form-container textarea:focus, .form-container select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.15);
            background-color: #f7fafc;
        }

        .form-container input:hover, .form-container textarea:hover, .form-container select:hover {
            background-color: #f7fafc;
            border-color: #90caf9;
        }

        .form-container textarea {
            min-height: 100px;
            resize: vertical;
            cursor: text;
        }

        .form-container button {
            border-radius: 0.75rem;
            padding: 1rem 2rem;
            font-size: 1.25rem;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0 4px 8px -1px rgba(0, 0, 0, 0.2);
            background-image: linear-gradient(to right, #4a5568, #2d3748);
            color: white;
            border: none;
            box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: auto;
            min-width: 150px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }

        .form-container button:hover {
            background-image: linear-gradient(to right, #374151, #1a202c);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.3);
        }

        .form-container button:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-container .text-red-500 {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: block;
        }

        /* General Card Styles */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.15), 0 3px 7px -2px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 15px rgba(100, 100, 255, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
            cursor: pointer;
            user-select: none;
        }

        .card-content {
            font-size: 1rem;
            color: #6b7280;
            line-height: 1.7;
            cursor: text;
            user-select: none;
        }

        /* Utility Classes (from your provided CSS) */
        .text-center { text-align: center; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .font-semibold { font-weight: 600; }
        .text-gray-700 { color: #4a5568; }
        .text-gray-800 { color: #2d3748; }
        .bg-gray-100 { background-color: #f7fafc; }
        .w-full { width: 100%; }
        .rounded-md { border-radius: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .font-bold { font-weight: 700; }
        .text-white { color: white; }
        .bg-green-500 { background-color: #48bb78; }
        .hover\:bg-green-700:hover { background-color: #2d6945; }
        .focus\:outline-none:focus { outline: none; }
        .focus\:shadow-outline:focus { box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); }
        .inline-flex { display: inline-flex; align-items: center; justify-content: center; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .text-left { text-align: left; }

        /* Additional styles for responsive layout and app sections */
        .container {
            max-width: 900px; /* Wider container for app content */
        }
        .header-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #2d3748; /* Darker header */
            color: white;
            border-radius: 0.75rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .header-nav h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .header-nav button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            margin-left: 10px;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .header-nav button:hover {
            background-color: #3e8e41;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr; /* Two columns on medium screens and up */
            }
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f4f8;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .list-item:last-child {
            margin-bottom: 0;
        }
        .list-item button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background-color: #007bff; /* A distinct blue for actions */
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .list-item button:hover {
            background-color: #0056b3;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-inter">
    <div class="container mx-auto p-6">
        <div id="message-box"></div>

        <header class="header-nav">
            <h1>Church Share-a-Ride</h1>
            <nav>
                <span id="userEmailDisplay" class="text-white text-lg mr-4" style="display:none;"></span>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700" style="display:none;">Logout</button>
            </nav>
        </header>

        <section id="authSection" class="form-container">
            <div class="form-title-panel">
                <h2 id="authFormTitle">Sign Up</h2>
            </div>
            <form id="signup-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="first_name" class="block">First Name:</label>
                        <input type="text" id="first_name" name="first_name" class="w-full" required>
                        <div id="first_name-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                    </div>
                    <div>
                        <label for="last_name" class="block">Last Name:</label>
                        <input type="text" id="last_name" name="last_name" class="w-full" required>
                        <div id="last_name-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                    </div>
                </div>
                <div>
                    <label for="gender" class="block">Gender:</label>
                    <select id="gender" name="gender" class="w-full" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                    <div id="gender-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <div>
                    <label for="city" class="block">City of Residence:</label>
                    <select id="city" name="city" class="w-full" required>
                        <option value="">Select City</option>
                        <option value="manila">Manila</option>
                        <option value="quezon_city">Quezon City</option>
                        <option value="caloocan">Caloocan</option>
                        <option value="las_pinas">Las Piñas</option>
                        <option value="makati">Makati</option>
                        <option value="malabon">Malabon</option>
                        <option value="mandaluyong">Mandaluyong</option>
                        <option value="marikina">Marikina</option>
                        <option value="muntinlupa">Muntinlupa</option>
                        <option value="navotas">Navotas</option>
                        <option value="paranaque">Parañaque</option>
                        <option value="pasay">Pasay</option>
                        <option value="pasig">Pasig</option>
                        <option value="pateros">Pateros</option>
                        <option value="san_juan">San Juan</option>
                        <option value="taguig">Taguig</option>
                        <option value="valenzuela">Valenzuela</option>
                    </select>
                    <div id="city-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <div>
                    <label for="facebook_link" class="block">Facebook Messenger Link:</label>
                    <input type="url" id="facebook_link" name="facebook_link" class="w-full" placeholder="https://m.me/yourprofile" required>
                    <div id="facebook_link-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <div>
                    <label for="signup_email" class="block">Email:</label>
                    <input type="email" id="signup_email" name="signup_email" class="w-full" placeholder="your.email@example.com" required>
                    <div id="signup_email-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <div>
                    <label for="signup_password" class="block">Password:</label>
                    <input type="password" id="signup_password" name="signup_password" class="w-full" required>
                    <div id="signup_password-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <div>
                    <label for="mobile_number" class="block">Mobile Number:</label>
                    <input type="tel" id="mobile_number" name="mobile_number" class="w-full" placeholder="09XXXXXXXXX" required>
                    <div id="mobile_number-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                    <p class="text-gray-500 text-sm mt-1">Format: 09XXXXXXXXX (11 digits, numbers only)</p>
                </div>
                <button type="submit" class="w-full">Sign Up <span id="signup-spinner" class="loading-spinner"></span></button>
                <div class="text-center mt-4">
                    <p>
                        Already have an account?
                        <a href="#" id="show-login-form" class="text-blue-500 hover:underline">Login here</a>
                    </p>
                </div>
            </form>

            <form id="login-form" class="space-y-6" style="display:none;">
                <div>
                    <label for="login_email" class="block">Email:</label>
                    <input type="email" id="login_email" name="login_email" class="w-full" placeholder="your.email@example.com" required>
                    <div id="login_email-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <div>
                    <label for="login_password" class="block">Password:</label>
                    <input type="password" id="login_password" name="login_password" class="w-full" required>
                    <div id="login_password-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <button type="submit" class="w-full">Login <span id="login-spinner" class="loading-spinner"></span></button>
                <div class="text-center mt-4">
                    <p>
                        Don't have an account?
                        <a href="#" id="show-signup-form" class="text-blue-500 hover:underline">Sign Up here</a>
                    </p>
                </div>
            </form>
        </section>

        <section id="appSection" class="card" style="display:none;">
            <div class="card-title text-center">Your Share-a-Ride Dashboard</div>
            <p class="card-content text-center mb-6">Welcome, <span id="userEmail"></span>!</p>

            <div class="flex flex-col sm:flex-row justify-center gap-4 mb-6">
                <button id="requestRideBtn" class="bg-blue-600 hover:bg-blue-700" style="display:none;">Request a Ride</button>
                <button id="offerRideBtn" class="bg-green-600 hover:bg-green-700" style="display:none;">Offer a Ride (Driver)</button>
            </div>

            <div id="rideRequestForm" class="form-container mb-6" style="display:none;">
                <div class="form-title-panel">
                    <h3>Request a Ride</h3>
                </div>
                <div>
                    <label for="destination" class="block">Destination:</label>
                    <input type="text" id="destination" placeholder="e.g., Church, Home, Event Venue" class="w-full" required>
                    <div id="destination-error" class="text-red-500 text-sm mt-1" style="display:none;"></div>
                </div>
                <button type="submit" class="w-full">Submit Request <span id="request-spinner" class="loading-spinner"></span></button>
            </div>

            <div class="dashboard-grid">
                <div id="availableRidesSection" class="card" style="display:none;">
                    <div class="card-title">Available Ride Requests</div>
                    <ul id="rideRequestsList" class="space-y-4">
                        <li>No pending ride requests.</li>
                    </ul>
                </div>

                <div id="myTripsSection" class="card">
                    <div class="card-title">My Recent Trips</div>
                    <ul id="myTripsList" class="space-y-4">
                        <li>No recent trips.</li>
                    </ul>
                </div>
            </div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        // Firebase Configuration - REPLACED WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDuRG37e5qWu1kN7aZQVBwyQwj1EbIieHE",
            authDomain: "wcsharearideinitiativeproject.firebaseapp.com",
            projectId: "wcsharearideinitiativeproject",
            storageBucket: "wcsharearideinitiativeproject.firebasestorage.app",
            messagingSenderId: "169826993800",
            appId: "1:169826993800:web:367bee8597df79406b813d",
            measurementId: "G-7RJV9Q4NCT" // Measurement ID for Google Analytics (optional)
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // Removed Firebase Storage initialization: const storage = firebase.storage();

        // --- DOM Elements ---
        const messageBox = document.getElementById('message-box');
        const logoutBtn = document.getElementById('logoutBtn');
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const authFormTitle = document.getElementById('authFormTitle');

        // Sign Up Form Elements
        const signupForm = document.getElementById('signup-form');
        const showLoginFormLink = document.getElementById('show-login-form');
        const firstNameInput = document.getElementById('first_name');
        const lastNameInput = document.getElementById('last_name');
        const genderInput = document.getElementById('gender');
        const cityInput = document.getElementById('city');
        const facebookLinkInput = document.getElementById('facebook_link');
        const signupEmailInput = document.getElementById('signup_email');
        const signupPasswordInput = document.getElementById('signup_password');
        const mobileNumberInput = document.getElementById('mobile_number');
        const signupSpinner = document.getElementById('signup-spinner');

        // Login Form Elements
        const loginForm = document.getElementById('login-form');
        const showSignupFormLink = document.getElementById('show-signup-form');
        const loginEmailInput = document.getElementById('login_email');
        const loginPasswordInput = document.getElementById('login_password');
        const loginSpinner = document.getElementById('login-spinner');


        // App Dashboard Elements
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const userEmailSpan = document.getElementById('userEmail');
        const requestRideBtn = document.getElementById('requestRideBtn');
        const offerRideBtn = document.getElementById('offerRideBtn');
        const rideRequestForm = document.getElementById('rideRequestForm');
        const destinationInput = document.getElementById('destination');
        const submitRequestBtn = document.getElementById('submitRequestBtn');
        const requestSpinner = document.getElementById('request-spinner');
        const availableRidesSection = document.getElementById('availableRidesSection');
        const rideRequestsList = document.getElementById('rideRequestsList');
        const myTripsList = document.getElementById('myTripsList');

        // --- Helper Functions ---

        /**
         * Displays a message box with a given message and type (success/error).
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-md shadow-md show`;
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-400');
                messageBox.classList.remove('bg-red-100', 'text-red-700', 'border-red-400', 'error');
            } else {
                messageBox.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400', 'error');
                messageBox.classList.remove('bg-green-100', 'text-green-700', 'border-green-400');
            }

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 4000); // Message disappears after 4 seconds
        }

        /**
         * Displays an error message for a specific form input.
         * @param {string} errorElementId - The ID of the div element to display the error.
         * @param {string} message - The error message.
         */
        function formErrorResponse(errorElementId, message) {
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) {
                errorElement.style.display = 'block';
                errorElement.textContent = message;
            }
        }

        /**
         * Clears all form error messages.
         */
        function clearFormErrors() {
            document.querySelectorAll('.text-red-500').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
        }

        /**
         * Shows a specific section and hides others.
         * @param {string} sectionId - The ID of the section to show.
         */
        function showSection(sectionId) {
            // Hide all main sections first
            authSection.style.display = 'none';
            appSection.style.display = 'none';

            // Show the requested section
            document.getElementById(sectionId).style.display = 'block';
        }

        /**
         * Updates the UI based on the current user's authentication state.
         * @param {firebase.User} user - The authenticated Firebase user object, or null.
         */
        function updateUIForUser(user) {
            if (user) {
                userEmailDisplay.textContent = user.email;
                userEmailDisplay.style.display = 'inline-block';
                logoutBtn.style.display = 'inline-block';
                showSection('appSection');
                loadMyTrips(user.uid); // Load user's trips
                checkUserRole(user.uid); // Determine if user is a driver or rider
            } else {
                userEmailDisplay.style.display = 'none';
                logoutBtn.style.display = 'none';
                showSection('authSection');
                // Ensure signup form is shown by default on logout
                showSignupForm();
                // Clear dynamic sections
                rideRequestsList.innerHTML = '<li>No pending ride requests.</li>';
                myTripsList.innerHTML = '<li>No recent trips.</li>';
                availableRidesSection.style.display = 'none';
                rideRequestForm.style.display = 'none';
                requestRideBtn.style.display = 'none';
                offerRideBtn.style.display = 'none';
            }
        }

        /**
         * Toggles between the Sign Up and Login forms.
         */
        function showLoginForm() {
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            authFormTitle.textContent = 'Login';
            clearFormErrors();
        }

        function showSignupForm() {
            signupForm.style.display = 'block';
            loginForm.style.display = 'none';
            authFormTitle.textContent = 'Sign Up';
            clearFormErrors();
        }

        // --- Event Listeners for UI Toggles ---
        logoutBtn.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showMessage('Logged out successfully!', 'success');
                updateUIForUser(null);
            } catch (error) {
                console.error('Error logging out:', error);
                showMessage('Logout failed: ' + error.message, 'error');
            }
        });

        showLoginFormLink.addEventListener('click', (event) => {
            event.preventDefault();
            showLoginForm();
        });

        showSignupFormLink.addEventListener('click', (event) => {
            event.preventDefault();
            showSignupForm();
        });

        // --- Authentication Logic ---

        // Sign Up Form Submission
        signupForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            clearFormErrors();

            let isValid = true;

            // Client-side validation
            if (!firstNameInput.value.trim()) { formErrorResponse('first_name-error', 'First Name is required'); isValid = false; }
            if (!lastNameInput.value.trim()) { formErrorResponse('last_name-error', 'Last Name is required'); isValid = false; }
            if (!genderInput.value) { formErrorResponse('gender-error', 'Gender is required'); isValid = false; }
            if (!cityInput.value) { formErrorResponse('city-error', 'City is required'); isValid = false; }
            if (!facebookLinkInput.value.trim()) { formErrorResponse('facebook_link-error', 'Facebook Link is required'); isValid = false; }
            else if (!/^https:\/\/m\.me\/.+$/.test(facebookLinkInput.value.trim())) { formErrorResponse('facebook_link-error', 'Please enter a valid Facebook Messenger link (e.g., https://m.me/yourprofile)'); isValid = false; }
            if (!signupEmailInput.value.trim()) { formErrorResponse('signup_email-error', 'Email is required'); isValid = false; }
            if (!signupPasswordInput.value.trim()) { formErrorResponse('signup_password-error', 'Password is required'); isValid = false; }
            else if (signupPasswordInput.value.trim().length < 6) { formErrorResponse('signup_password-error', 'Password must be at least 6 characters long'); isValid = false; }
            if (!mobileNumberInput.value.trim()) { formErrorResponse('mobile_number-error', 'Mobile Number is required'); isValid = false; }
            else if (!/^09\d{9}$/.test(mobileNumberInput.value)) { formErrorResponse('mobile_number-error', 'Mobile Number must be 11 digits starting with 09'); isValid = false; }

            if (!isValid) {
                showMessage('Please correct the errors in the form.', 'error');
                return;
            }

            signupSpinner.style.display = 'inline-block'; // Show spinner

            try {
                // 1. Create user with Email and Password
                const userCredential = await auth.createUserWithEmailAndPassword(signupEmailInput.value, signupPasswordInput.value);
                const user = userCredential.user;

                // 2. Store user profile data in Firestore
                await db.collection('users').doc(user.uid).set({
                    firstName: firstNameInput.value,
                    lastName: lastNameInput.value,
                    gender: genderInput.value,
                    city: cityInput.value,
                    facebookLink: facebookLinkInput.value,
                    email: signupEmailInput.value,
                    mobileNumber: mobileNumberInput.value,
                    role: 'rider', // Default role for new users
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showMessage('Account created and signed in successfully!', 'success');
                signupForm.reset();
                signupSpinner.style.display = 'none'; // Hide spinner

            } catch (error) {
                console.error('Sign Up error:', error);
                showMessage('Sign Up failed: ' + error.message, 'error');
                signupSpinner.style.display = 'none'; // Hide spinner
            }
        });

        // Login Form Submission
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            clearFormErrors();

            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!email || !password) {
                formErrorResponse('login_email-error', 'Email and password are required.');
                showMessage('Please enter your email and password.', 'error');
                return;
            }

            loginSpinner.style.display = 'inline-block'; // Show spinner

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showMessage('Logged in successfully!', 'success');
                loginForm.reset();
                loginSpinner.style.display = 'none'; // Hide spinner
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Login failed: ' + error.message, 'error');
                loginSpinner.style.display = 'none'; // Hide spinner
            }
        });

        // --- User Roles (Crucial for Driver/Rider distinction) ---
        /**
         * Checks the current user's role and updates UI visibility.
         * @param {string} uid - The user's UID.
         */
        async function checkUserRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userEmailSpan.textContent = userData.email; // Update email in dashboard
                    if (userData.role === 'driver') {
                        offerRideBtn.style.display = 'inline-block';
                        requestRideBtn.style.display = 'none';
                        availableRidesSection.style.display = 'block';
                        loadAvailableRideRequests(); // Load requests for drivers
                    } else {
                        offerRideBtn.style.display = 'none';
                        requestRideBtn.style.display = 'inline-block';
                        availableRidesSection.style.display = 'none'; // Hide driver section for riders
                    }
                } else {
                    // Fallback if user document doesn't exist (should be created on signup)
                    showMessage('User profile not found. Please contact support.', 'error');
                    requestRideBtn.style.display = 'inline-block'; // Default to rider
                    offerRideBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking user role:', error);
                showMessage('Error loading user role.', 'error');
            }
        }

        // --- Ride Request (Rider) ---
        requestRideBtn.addEventListener('click', () => {
            rideRequestForm.style.display = 'block';
            availableRidesSection.style.display = 'none'; // Hide driver view
        });

        submitRequestBtn.addEventListener('click', async () => {
            const destination = destinationInput.value.trim();
            const user = auth.currentUser;

            clearFormErrors();
            if (!destination) {
                formErrorResponse('destination-error', 'Destination is required.');
                showMessage('Please enter a destination.', 'error');
                return;
            }

            if (!user) {
                showMessage('You must be logged in to request a ride.', 'error');
                return;
            }

            requestSpinner.style.display = 'inline-block'; // Show spinner

            try {
                await db.collection('ride_requests').add({
                    riderId: user.uid,
                    riderEmail: user.email,
                    destination: destination,
                    status: 'pending', // pending, accepted, completed, cancelled
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp for accuracy
                });
                showMessage('Ride request submitted successfully!', 'success');
                destinationInput.value = '';
                rideRequestForm.style.display = 'none';
            } catch (error) {
                console.error('Error submitting ride request:', error);
                showMessage('Failed to submit request: ' + error.message, 'error');
            } finally {
                requestSpinner.style.display = 'none'; // Hide spinner
            }
        });

        // --- Offer Ride (Driver) & View Requests ---
        offerRideBtn.addEventListener('click', () => {
            rideRequestForm.style.display = 'none'; // Hide rider view
            availableRidesSection.style.display = 'block';
            loadAvailableRideRequests(); // Refresh requests when driver clicks button
        });

        /**
         * Loads and displays available pending ride requests for drivers.
         * Uses onSnapshot for real-time updates.
         */
        async function loadAvailableRideRequests() {
            rideRequestsList.innerHTML = '<li class="list-item">Loading requests...</li>';
            try {
                db.collection('ride_requests')
                    .where('status', '==', 'pending')
                    .orderBy('timestamp', 'asc') // Order by oldest first
                    .onSnapshot(snapshot => {
                        rideRequestsList.innerHTML = ''; // Clear existing list
                        if (snapshot.empty) {
                            rideRequestsList.innerHTML = '<li class="list-item">No pending ride requests.</li>';
                            return;
                        }
                        snapshot.forEach(doc => {
                            const request = doc.data();
                            const li = document.createElement('li');
                            li.className = 'list-item';
                            li.innerHTML = `
                                <span>Rider: ${request.riderEmail}<br>Destination: ${request.destination}</span>
                                <button data-id="${doc.id}" class="accept-ride-btn">Accept</button>
                            `;
                            rideRequestsList.appendChild(li);
                        });
                        // Add event listeners to newly created buttons
                        document.querySelectorAll('.accept-ride-btn').forEach(button => {
                            button.onclick = (e) => acceptRide(e.target.dataset.id);
                        });
                    }, error => {
                        console.error("Error listening to ride requests:", error);
                        showMessage('Error loading ride requests.', 'error');
                        rideRequestsList.innerHTML = '<li class="list-item">Error loading requests.</li>';
                    });
            } catch (error) {
                console.error('Error setting up ride request listener:', error);
                showMessage('Error setting up ride request listener.', 'error');
                rideRequestsList.innerHTML = '<li class="list-item">Error loading requests.</li>';
            }
        }

        /**
         * Handles a driver accepting a ride request.
         * @param {string} requestId - The ID of the ride request document.
         */
        async function acceptRide(requestId) {
            const user = auth.currentUser;
            if (!user) {
                showMessage('Please login to accept a ride.', 'error');
                return;
            }

            try {
                const requestDocRef = db.collection('ride_requests').doc(requestId);
                const requestDoc = await requestDocRef.get();

                if (!requestDoc.exists || requestDoc.data().status !== 'pending') {
                    showMessage('This ride request is no longer available or has been accepted.', 'error');
                    return;
                }

                const requestData = requestDoc.data();

                // Use a Firestore transaction for atomicity (optional but good practice for critical updates)
                await db.runTransaction(async (transaction) => {
                    // Re-read the request within the transaction to ensure it's still pending
                    const freshRequestDoc = await transaction.get(requestDocRef);
                    if (!freshRequestDoc.exists || freshRequestDoc.data().status !== 'pending') {
                        throw new Error('Ride request status changed during transaction.');
                    }

                    // 1. Update the request status
                    transaction.update(requestDocRef, {
                        status: 'accepted',
                        driverId: user.uid,
                        driverEmail: user.email,
                        acceptedTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // 2. Create a new trip log entry
                    transaction.set(db.collection('trips').doc(), { // Firestore automatically generates ID
                        riderId: requestData.riderId,
                        riderEmail: requestData.riderEmail,
                        driverId: user.uid,
                        driverEmail: user.email,
                        destination: requestData.destination,
                        startTime: firebase.firestore.FieldValue.serverTimestamp(), // Actual start time of the trip
                        status: 'ongoing', // ongoing, completed, cancelled
                        requestId: requestId // Link back to the original request
                    });
                });

                showMessage('Ride accepted! Trip initiated.', 'success');
                loadMyTrips(user.uid); // Driver's trips will now show the ongoing trip
            } catch (error) {
                console.error('Error accepting ride:', error);
                showMessage('Failed to accept ride: ' + error.message, 'error');
            }
        }

        // --- My Trips (Rider & Driver) ---
        /**
         * Loads and displays the current user's recent trips (as rider or driver).
         * Uses onSnapshot for real-time updates.
         * @param {string} uid - The user's UID.
         */
        async function loadMyTrips(uid) {
            myTripsList.innerHTML = '<li class="list-item">Loading your trips...</li>';
            try {
                // Use onSnapshot for real-time updates for both rider and driver trips
                // This will set up two listeners. For very large scale, consider more complex queries.
                db.collection('trips')
                    .where('riderId', '==', uid)
                    .orderBy('startTime', 'desc')
                    .limit(10) // Limit to recent trips to save reads
                    .onSnapshot(riderSnapshot => {
                        updateMyTripsList(uid, riderSnapshot, 'rider');
                    }, error => {
                        console.error("Error listening to rider trips:", error);
                        showMessage('Error loading rider trips.', 'error');
                    });

                db.collection('trips')
                    .where('driverId', '==', uid)
                    .orderBy('startTime', 'desc')
                    .limit(10) // Limit to recent trips to save reads
                    .onSnapshot(driverSnapshot => {
                        updateMyTripsList(uid, driverSnapshot, 'driver');
                    }, error => {
                        console.error("Error listening to driver trips:", error);
                        showMessage('Error loading driver trips.', 'error');
                    });

            } catch (error) {
                console.error('Error setting up my trips listener:', error);
                showMessage('Error setting up trip listener.', 'error');
                myTripsList.innerHTML = '<li class="list-item">Error loading your trips.</li>';
            }
        }

        let allLoadedTrips = {}; // Store trips by ID to merge from both snapshots

        /**
         * Helper function to update the myTripsList from snapshots.
         * @param {string} uid - Current user's UID.
         * @param {firebase.firestore.QuerySnapshot} snapshot - The Firestore snapshot.
         * @param {string} roleType - 'rider' or 'driver' to indicate the type of trip.
         */
        function updateMyTripsList(uid, snapshot, roleType) {
            snapshot.docChanges().forEach(change => {
                const trip = change.doc.data();
                const tripId = change.doc.id;

                if (change.type === 'added' || change.type === 'modified') {
                    allLoadedTrips[tripId] = { ...trip, type: roleType, id: tripId };
                } else if (change.type === 'removed') {
                    delete allLoadedTrips[tripId];
                }
            });

            const uniqueTrips = Object.values(allLoadedTrips)
                                    .sort((a, b) => (b.startTime?.toMillis() || 0) - (a.startTime?.toMillis() || 0));

            myTripsList.innerHTML = ''; // Clear existing list
            if (uniqueTrips.length === 0) {
                myTripsList.innerHTML = '<li class="list-item">No recent trips.</li>';
                return;
            }

            uniqueTrips.forEach(trip => {
                const li = document.createElement('li');
                li.className = 'list-item';
                const displayRole = trip.riderId === uid ? 'Rider' : 'Driver';
                const partnerEmail = trip.riderId === uid ? (trip.driverEmail || 'N/A') : (trip.riderEmail || 'N/A');
                const partnerLabel = trip.riderId === uid ? 'Driver' : 'Rider';

                li.innerHTML = `
                    <span>
                        Role: ${displayRole} -
                        Destination: ${trip.destination} -
                        Status: ${trip.status.charAt(0).toUpperCase() + trip.status.slice(1)}<br>
                        ${partnerLabel}: ${partnerEmail} -
                        Start: ${trip.startTime ? trip.startTime.toDate().toLocaleString() : 'N/A'}
                    </span>
                    ${trip.status === 'ongoing' && trip.driverId === uid ? `<button data-id="${trip.id}" class="complete-trip-btn">Complete Trip</button>` : ''}
                `;
                myTripsList.appendChild(li);
            });

            // Re-attach event listeners for "Complete Trip" buttons
            document.querySelectorAll('.complete-trip-btn').forEach(button => {
                button.onclick = (e) => completeTrip(e.target.dataset.id);
            });
        }

        /**
         * Marks an ongoing trip as completed.
         * @param {string} tripId - The ID of the trip document.
         */
        async function completeTrip(tripId) {
            const user = auth.currentUser;
            if (!user) {
                showMessage('You must be logged in to complete a trip.', 'error');
                return;
            }

            try {
                const tripDocRef = db.collection('trips').doc(tripId);
                const tripDoc = await tripDocRef.get();

                if (!tripDoc.exists || tripDoc.data().status !== 'ongoing' || tripDoc.data().driverId !== user.uid) {
                    showMessage('This trip cannot be completed by you or is not ongoing.', 'error');
                    return;
                }

                await tripDocRef.update({
                    status: 'completed',
                    endTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                showMessage('Trip marked as completed!', 'success');
                // loadMyTrips will automatically update due to onSnapshot
            } catch (error) {
                console.error('Error completing trip:', error);
                showMessage('Failed to complete trip: ' + error.message, 'error');
            }
        }

        // --- Mobile Number Input Formatting ---
        mobileNumberInput.addEventListener('input', (event) => {
            let value = event.target.value.replace(/\D/g, ''); // Remove non-numeric characters
            if (value.length > 0 && !value.startsWith('09')) {
                value = '09' + value.slice(0, 9); // Force "09" prefix and limit to 11 digits
            } else if (value.length > 11) {
                value = value.slice(0, 11); // Limit to 11 digits
            }
            event.target.value = value;
        });

        mobileNumberInput.addEventListener('keypress', (event) => {
            const charCode = event.which ? event.which : event.keyCode;
            if (charCode < 48 || charCode > 57) { // Only allow numbers
                event.preventDefault();
            }
        });

        // Initial UI update on page load
        auth.onAuthStateChanged(user => {
            updateUIForUser(user);
        });
    </script>
</body>
</html>
